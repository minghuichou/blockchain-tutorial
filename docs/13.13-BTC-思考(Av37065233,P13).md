**13.13-BTC-思考(Av37065233,P13)**

到目前为止，我们已经把比特币这部分基本上讲完了。这节课我们一起来思考一些问题。第一个我们要思考的问题是哈希指针。比特币系统在设计当中很多地方用到了哈希指针。比如说区块的块头就包含指向前一个区块的哈希指针。

大家有没有想过一个问题，指针保存的是本地内存的地址，那么只是在本地这台计算机上才有意义，发送到其他的计算机上就没有意义。那么在发布区块的时候，哈希指针是怎么能够通过网络进行传输的呢？大家听明白了吗？大家都知道指针吧？你们本科的时候都学过，指针当中的地址只在本地有意义，你发送到别的计算机就没有意义了。那区块链中这哈希指针是怎么进行传播的？

所谓的哈希指针只是一种形象的说法，实际系统中用的时候只有哈希没有指针。我们回顾一下我们之前看到的block
head的数据结构。

这就是block
head的数据结构，这个地方就是指向前一个区块的哈希，那么指针在哪里？没有指针，block
hea里面只有哈希值，没有指针，那怎么才能找到前一个区块的内容呢？全节点一般是把这些区块存储在一个K8数据库里面。

这个key就是这个区块的哈希，这个value就是这个区块的内容。一个常用的K86数据库是nid
b。

所谓的区块链这种链表结构，实际上是在level
db里面用哈希值来串起来的。只要你掌握了最后一个区块的哈希值，那么你通过这个nidb例查找这个哈希值这个key对应的value，就可以把最后一个区块的内容取出来。然后这个区块里面，header里面，这个块头里面又有指向前一个区块的哈希值，那么再去查找这个key和value，可以找到前一个区块的内容。以此类推，一步一步往前找，最终能够把整个区块链都找出来。所以说在实际系统当中，所谓的哈希指针是只有哈希没有指针。或者你也可以认为哈希纸本身就是指人。

有一些节点没有保存完整的区块链的信息，只保存了最近的几千个区块。如果需要用到前面的区块的信息，可以问其他的全叠点要哈希指针的性质保证了整个区块链的内容是不可篡改的。大家有问题吗？

没有问题，我们讲第二点，区块链。

大家听说过这个说法吗？区块链。据说去年七夕的时候，有的情侣两个人合在一起买比特币，把私钥从中间阶段分成两部分，每人保留其中的一段。将来如果两个人继续好下去的话，那么两段私要合在一起就能够把钱取出来。如果两个人分手了，那么当初买的币就被永久的锁在区块链上，谁也取不出来。所以这个叫做区块链用blockchain的不可篡改性来作为两个人的爱情见证。大家想想，这么做有什么问题吗？

这样的做法如果要推广下去的话，N个人的账户该怎么办？比如说某个商户有四个合伙人，那么按照这种设计的逻辑的话，应该把饲药切成4份，每个合伙人掌握其中的一份，需要用的时候，四个人的饲药拼在一起才能用。这样做有什么问题？一个比较显然的问题是，四个人当中任何一个人如果把私药丢了，这个钱都取不出来了。

其实还有更大的一个问题，这种截断私药的做法会降低账户的安全性，为什么这么说呢？比特币系统当中，每个账户的安全性跟所用的私钥的长度是相关的。为什么要用256倍的私药？因为这个长度的私药用暴力破解的方法是不可行的，计算量太大。就算你把全世界所有的计算机都集中起来去破解这256位的私钥，也是不可能成功的。但是如果你从中截断，比如说这个区块链的例子。假设两个情侣当中有一个人分手之后想把这个钱取出来。他已经知道了其中一半的私药，128位的私药，只要把剩下的128味私药猜出来就行了。

大家不要产生一个错觉，不要觉得好像把撕药的长度减小一半之后，破解的难度也会降低一半。不是这样的，256位的私药有多少种可能性？有这么多种对吧？降到128位。这两个的差距远远不止不是只差一倍，这个要远远大于这个。

破解的难度变得容易很多了。前面那个四个合伙人的例子，假设有三个合伙人串通起来，瞒着剩下的一个人要把钱取出来，那么他只要尝试多少种可能性。这就可以了，这个差了也是不止一倍，远远不止一倍。

说这个例子说明什么？对于多个人的共享账户，不要用截断私钥的方法，那怎么办呢？用多重签名。

大家还记得吗？我们以前讲比特币脚本的时候讲过多重签名。这个多重签名当中用到的每每一个私钥都是独立产生的，而不是说把一个大的私要拆成好几段。而且多重签名还提供一些别的灵活性。比如说可以要求N个人当中任意给出M个人签名就可以了。这种区块链的做法。还有另外一个问题，就如果这两个人真的是分手了，那么他们当初买的这个币就会永久的保存在uso里面。

这个对矿工是不友好的，uso里面的这种死钱是个普遍的问题。我们这个例子当中，这个矿工并不知道这对情侣已经分手了，这个钱实际上是取不出来的，所以他要永远把这笔钱保存在U手里面。还有一些别的原因，这个可能变成死前的。像比特币早期的时候，那个时候比特币是不值钱的。很多人就是觉得新鲜，听说出这么一个玩意儿叫比特币，然后就挖矿挖着玩，挖到以后也不当回事儿，就扔在硬盘里。所以那个时候有很多私钥是丢失的。这些丢失私钥的这些输出也是被永久的保存在UTSO里面，造成这个集合的膨胀。大家有问题吗？

我们要讨论的第三个问题是分布式共识。我们前面讲比特币的共识协议的时候说过，关于分布式共识有很多不可能的结论。就学术界有很多著名的科学家给出了各种impossibility
results，从理论上证明分布式系统当中取得共识是不可能的。既然理论上已经证明了是不可能的，实际当中又怎么变得可能？就比特币怎么可能取得共识？为什么它能够绕过分布式系统理论上证明的那些不可能结论。

严格的说，比特币并没有取得真正意义下的共识，因为取得的共识随时都有可能被推翻。比如出现了分叉攻击，本来你以为已经达成了某一个共识，分叉攻击之后系统会回滚到前一个状态，从理论上说，甚至可能一直回滚到创世纪块。按照分布式系统理论的要求，共识一旦达成之后就不应该再改了。所以从这个意义上说，比特币并没有绕过分布式系统那些不可能的结论，因为它并没有达到真正意义下的共识。

这个事情其实还有一个更重要的启示，就是理论和实际往往是有距离的。很多理论上不可能结论对于实际当中是并不适用的。因为这个不可能结论只是对某种特定的模型下是不可能的。实际当中你把模型稍微改一改，这个不可能结论就不成立了。

以前我在美国A天G实验室工作的时候，有一次开会。当时有人问的一个问题是，你怎么判断远程数据中心的一台服务器是不是已经死机了？你发现是连不上它是，但它是不是真的死机了？这个大概是十几年前的事情，那个时候远程控制卡还不是很普遍，就大多数的服务器是没有远程控制卡的。

At天NT实验室是在美国的新泽西州，大家听说过贝尔实验室，对吧？就原来这两个是一个实验室，就A天气实验室的前身就是贝尔实验室。后来96年的时候，朗讯跟atnt分家了，分成两个公司了。他这个贝尔实验室也拆为两部分，朗讯公司的那个还是继续叫贝尔实验室，ATT这部分就改成叫att
t实验室。它在新泽西州，而那个数据中心是在美国西部的某一个州。

我们能观察到的情况就是我们连那个数据中心的服务器是连不上了，这有可能那个服务器本身是垮掉了，也有可能就是网络有一些拥堵，所以连不上。怎么区分这两种情况，我们当时还没有说几句。然后旁边有一个资深的分布式系统的专家就坐不住了，他说这个问题不用讨论了，这是不可能区分出来的。分布式系统的理论已经证明了，在异步的环境中。

在这种异步的环境中，不可能区分某台远程的服务器到底是垮掉了，还是说仅仅是运行缓慢。他这个话说的并没有错，分布式系统的理论体系里面确实是有这个结论。我原来一直是都是搞分布式系统的，大概是从二十多年前在康奈尔读博士的时候，就是搞分布式系统的，一直到现在。这个不可能结论。

其实你仔细想一下是很显然的，所谓的异步环境是说通讯传输的延迟是没有上限的。我发一个消息给你，你什么时候能收到谁也不知道。所以如果你看到一个远程服务器连不上，有可能是这个服务器本身死掉了，也可能就是这个通讯的延迟太长了。也许你等到下一秒就能够连上了。这就是为什么说这两种情况是没有办法区分开的。

那怎么办呢？

是不是说实际当中遇到这种情况就束手无策？这个时候，我们那边有一个搞实际操作的人，他说他遇到这种情况会给数据中心的值班人员打一个电话，让他去看一看这台服务器是个什么情况。如果确实是死机的话，帮着给重启一下，因为没有远程控制卡，当时只能手工冲洗。所以这个理论上的不可能，现实中就又变成了可能了。

大家想一下这个例子说明什么问题？其实跟比特币说明了道理是一样的。理论上很多不可能的结论，只是在某个特定的模型下，现实生活中把这个模型改一改。像我们这个例子当中，你通过给对方的值班人员打电话实地查看一下，这个模型就不是理论上的这种异补模型。所以理论上的不可能，结论也就不成立了。听明白了吗？

这个故事到这里还没有完，我们实际当中是怎么操作的呢？因为如果每次你发现有问题都给值班人员打电话也比较麻烦。所以我们的做法是给这个服务器加一根电话线，那个时候服务器一般是有两个插口，一个是可以插enet的，另外一个是插电话线用于拨号上网的。这个是十几年前的事情，就那个时候用电话线拨号上网还是比较普遍的，现在没有人怎么干了，现在你们谁还用电话线去拨号上网？但当时是一种常见的做法，我那个时候还发表过一篇论文，就是讲在拨号上网的情况下怎么进行流量优化。

那么连两根线有什么好处？平时的时候你操作都是用这个esnet这根线去连的。如果你发现连不上了，那么就试一下这个拨号上网这根线，这个电话线。因为这个电话网络跟这个Internet是两个网络，一般来说不会同时出现拥堵。所以如果你发现电话线也连不上，那么一般是说明他真的是死机了。

这些事情能够给我们什么样的启示？我们说知识改变命运这个话本身没有错，但是对知识的一知半解有可能使你的命运变得更差。发明比特币的这个钟本聪，他应该不是学术界出身，否则不太可能设计出像比特币这样的系统来。同学们都是北大的研究生，都是非常优秀的，搞科研是很有意义的，我搞科研已经搞了这么多年了。但是大家注意不要被学术界的思维限制了头脑，不要被程序员的思维限制了想象力。同学们在这么热的夏天来上这个暑期课，如果没有学到别的话，记住我说的这句话，也是很有价值的。

第四个我们要讨论的问题就是跟比特币的稀缺性相关的。比特币系统中的矿工为什么要挖矿？为了获得收益，挖矿的收益要大于挖矿的开销，那么才是有利可图的。所以要想吸引大家来挖矿，要么增加挖矿的预期收益，要么降低挖矿的开销。

任何一种新发行的这种加密货币都有一个能启动的问题。早期的时候你这个加密货币不是很流行，怎么吸引大家来挖矿，给早期的矿工更多的收益，这个其实也是合理的，因为早期的矿工承担的风险也是更大的。那么比特币是怎么做到这一点呢？两个方面，一方面早期的挖矿难度比较低，很容易就可以挖到。另一方面早期的出块奖励也是比较高的，每个许可尔是50个比特币，现在就降到了12.5个，然后越往后还会越来越少。

有人认为比特币这样设计是非常巧妙的，因为相当于比特币的总量是恒定的。我们之前课上讲过，它构成了一个几何级数，最后可以算出总量是一个固定的数，越到后面越难挖，所以大家都会抢着去挖。有些人认为这是比特币获得成功的一个原因，其实这种总量固定的东西是不适合用来作为货币的。我们后面会讲到以太坊，以太坊就没有这种出块奖励定期减半的做法，有一些新型的加密货币，甚至要自带这种通胀的功能，每年会自动把货币的发行量提高一定的比例。

为什么要这么设计？稀缺的东西是不适合用来做货币的。我们平时总觉得通货膨胀是件坏事情，因为钱变得越来越不值钱。但是一个好的货币其实是要有通货膨胀的功能的。如果这个东西这个货币的总量是定死了，它是不适合用来做货币的。

有些人可能觉得不对，那黄金呢？黄金不是用来作为货币吗？黄金在古代的时候确实有很长一段时间是用来作右货币的。但是现代社会基本上都废弃了精本位置，不再用黄金来作为货币。

严格的说，黄金的总量并不是定死的，每年都有一些新的金矿被发掘出来，但是每年黄金产量增加的速度远远赶不上社会新创造财富的速度。每年能挖出来的黄金能有多少？每年创造出的财富又有多少？

所以如果我们用黄金作为货币的话，会有什么样的情况？黄金会变得越来越值钱。因为社会财富越来越多了，都集中在这个少量的黄金上，会变得越来越值钱。如果某个人早期拥有黄金，比如说他们家主上传下来一锭金子，那么这个人就不用工作了，就可以坐在家里看着财富不断的增长，后来的人永远也赶不上。如果你早期没有买这些黄金的话，你后面怎么赶也赶不上。这个情况大家听起来有没有觉得有点耳熟？国内这些年的房地产就是这种情况，如果房价持续保持这种疯涨的态势的话，那么已经买房的人就会变得越来越富，没有买房的人就永远也买不起。个人奋斗变得没有意义了，一个健康向上的社会是不应该出现这种情况。

比特币最近几年的平均涨幅已经超过了北京的房价。大家如果对这方面的内容比较感兴趣的话，可以看一下货币金融学的相关知识。最后我们讨论一下量子计算。因为这个事情经常会有人提出来。最近几年量子计算发展的很快，同学们都听过各种各样这方面的报道。有人就产生了这样一种担心，像比特币这样的加密货币是建立在密码学的基础上。那么将来量的计算技术发展起来之后，这些加密货币会不会变得不安全了？

传说当中的量子计算机是非常强大的，可以破解各种现有的加密式算法。这个担心是不必要的。首先量子计算技术离实用还有很长一段距离。虽然这种各种报道当中都说的它非常神奇，非常牛，但实际上量子计算离实用还差的很远。

在比特币的有生之年不一定能够产生实质性的威胁。而且如果将来有一天量子计算真正强大到能够破坏现有的加密体系的话，那么首先冲击的是传统金融业。像我们日常生活中在网上进行的很多金融活动，网上银行、网上转账、网上支付，都会变得不安全。所以与其担心量子计算对比特币的冲击，还不如担心量子计算对传统金融业的冲击。因为大多数的钱还是放在传统金融业里面的，加密货币的总市值只占了现代金融体系当中的很小一部分，而且将来还会有量子加密算法，所以这是我说的第一方面。

第二方面，比特币当中并没有把账户的公钥直接暴露出来，而是用公钥取哈希之后得到一个地址。比特币当中用的非对称加密体系，从这个私钥是可以推导出公钥的这是比特币加密算法的一个特点。所以只要你把私钥保管好，公钥即使丢了也没有关系。那么从公钥当中显然是不能推出私钥的，否则就麻烦了。假设将来将这个量子计算技术发达了，能够从公钥中推出私钥，那怎么办呢？

比特币在设计的时候又加了一层保护，没有用公药本身，而是用公钥的哈希。所以如果有人想偷你账户上的钱的话，首先是要用这个地址推导出你这个公钥。相当于把这个公钥的哈希值进行逆运算，推导出原来的公钥本身。而这一点即使是用量子计算机也是没有办法完成的。大家听明白了吗？

加密和曲哈希是两个不同性质的操作。加密的目的是为了将来能够解密，所以加密算法要保证信息的完整性，加密过程是不能够丢失信息的，这样将来解密的时候才能够还原出原来的输入。但是取哈希的过程一般来说是会造成信息的损失的。哈希函数一般都是不可逆的，从这个哈希值没有办法推导出原来的输入是什么，因为有很多信息在取哈希的过程中就已经丢失了。这个道理大家仔细想一想，其实是很容易理解的。比如比特币当中用的哈希算法是什么？

我们前面讲过Secure Hash
Algorithm算出的哈希值是256位的。不论这个输入有多大，你这个输入哪怕有几个T几十个T算出来的哈希值也是256位的。那么这样的运算过程显然是不可逆的这要是能可逆的话变成什么了？变成一个超级无敌的压缩算法。你可以把所有的信息，北大图书馆整个图书馆的信息都作为输入，算出一个256位的哈希值，然后将来用到的时候再反推出原来的输入，能变成一种超级的压缩算法了。这是不可行的。

所以比特币系统当中，如果你仅仅是为了收钱的话，收款的话没必要把公钥暴露出来，只暴露一个公钥的哈希生成的地址就行了。将来你要取钱的时候才需要提供公钥。你取钱的那个交易里面得有公钥，还要有一个私要产生的一个签名。

假设有一个坏人在网上监听到了你取钱的这个交易，知道你的公钥是什么，他要偷你的钱需要怎么做，他要实时的从这个公钥推导出这个私钥来，要把私钥实时的破解了。然后要产生一个跟你竞争的交易，你要把钱转到你的某个账户，他这个交易要把钱转到他的个账户。即使这个坏人拥有量子计算技术，也很难在几分钟之内就把你的私咬破解了。而且他发布的这个交易还要抢在你这个交易的前面。因为一旦你要是把这个账上的钱已经转走了，他这个交易就没有用了。这两个交易是有冲突的，是double
bospending ding。

所以从安全性的角度来看，比特币的一个地址一旦用过之后就不要再用了。每次你从这个地址取钱的时候，最好是一次性的把里面所有的钱都取走。那么除了支付给别人的那部分钱之外，剩下的钱可以转给自己的另外一个账户。这样做不但增加了安全性，而且也提高了这种隐私保护的程果。

我们后面会讲到以太坊中的地址也是从公钥中推导出来的，但也不是公钥本身，也是公钥取了哈希之后进行了转换，其实就是从前面截断了一部分，这个说明什么？即使是公钥也不要随便泄露。如果你很担心量子计算的威胁的话。还有别的问题吗？好，没有的话，我们这节课就到这里了。
